name: Liquibase Preview

on:
  workflow_call:
    inputs:
      project_id:
        required: true
        type: string
        description: "GCP Project ID"
      region:
        required: false
        type: string
        default: "us-central1"
      wif_provider:
        required: true
        type: string
        description: "Workload Identity Federation provider"
      service_account:
        required: true
        type: string
        description: "GCP Service Account email"
      artifact_registry:
        required: true
        type: string
        description: "Artifact Registry URL"
      repository:
        required: true
        type: string
        description: "Artifact Registry repository name"
      image_name:
        required: true
        type: string
        description: "Docker image name"
      job_name:
        required: true
        type: string
        description: "Cloud Run Job name"
      database_name:
        required: true
        type: string
        description: "Target database name"
      changelog_file:
        required: false
        type: string
        default: "changelog.master.xml"
      db_secret_name:
        required: true
        type: string
        description: "Secret Manager secret name for DB password"
      dockerfile:
        required: false
        type: string
        default: "Dockerfile.liquibase"
      apply_workflow_name:
        required: false
        type: string
        default: "liquibase-apply.yml"
        description: "Name of the apply workflow file for Slack link"
    secrets:
      SLACK_WEBHOOK_URL:
        required: false

permissions:
  contents: read
  id-token: write

jobs:
  preview:
    name: Preview Migration (update-sql)
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ inputs.project_id }}
      REGION: ${{ inputs.region }}
      ARTIFACT_REGISTRY: ${{ inputs.artifact_registry }}
      REPOSITORY: ${{ inputs.repository }}
      IMAGE_NAME: ${{ inputs.image_name }}
      JOB_NAME: ${{ inputs.job_name }}
      DATABASE_NAME: ${{ inputs.database_name }}
      CHANGELOG_FILE: ${{ inputs.changelog_file }}
      DB_SECRET_NAME: ${{ inputs.db_secret_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ inputs.wif_provider }}
          service_account: ${{ inputs.service_account }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "$ARTIFACT_REGISTRY"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          push: true
          tags: |
            ${{ inputs.artifact_registry }}/${{ inputs.project_id }}/${{ inputs.repository }}/${{ inputs.image_name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get DB Host from existing job
        id: db-host
        run: |
          DB_HOST=$(gcloud run jobs describe "$JOB_NAME" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --format="value(spec.template.spec.template.spec.containers[0].env[0].value)")
          echo "host=$DB_HOST" >> $GITHUB_OUTPUT

      - name: Run preview (update-sql)
        id: preview
        run: |
          DB_HOST="${{ steps.db-host.outputs.host }}"
          JDBC_URL="jdbc:postgresql://${DB_HOST}:5432/$DATABASE_NAME"

          gcloud run jobs update "$JOB_NAME" \
            --image="$ARTIFACT_REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:${{ github.sha }}" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --set-env-vars="LIQUIBASE_COMMAND_URL=$JDBC_URL,LIQUIBASE_COMMAND_USERNAME=postgres" \
            --set-secrets="LIQUIBASE_COMMAND_PASSWORD=${DB_SECRET_NAME}:latest" \
            --args="--changelog-file=$CHANGELOG_FILE,update-sql"

          echo "Executing preview (update-sql)..."
          gcloud run jobs execute "$JOB_NAME" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --wait

          echo "Preview completed."

      - name: Get execution logs
        id: logs
        run: |
          echo "Fetching preview logs..."
          sleep 5

          LOGS=$(gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=$JOB_NAME" \
            --limit=200 \
            --project="$PROJECT_ID" \
            --format="value(textPayload)" \
            --freshness=5m 2>/dev/null || echo "Could not fetch logs")

          echo "$LOGS" > preview-output.txt

          # Check if there are SQL statements
          if echo "$LOGS" | grep -qE "CREATE|ALTER|DROP|INSERT|UPDATE|DELETE|^--"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: liquibase-preview-${{ github.run_id }}
          path: preview-output.txt
          retention-days: 7

      - name: Set Slack mention
        id: mention
        env:
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          # Leer mapeo desde JSON centralizado
          SLACK_MAP=$(curl -s "https://raw.githubusercontent.com/TetherEducation/tether-ci-cd/staging/config/slack-users.json")
          SLACK_ID=$(echo "$SLACK_MAP" | jq -r --arg user "$GITHUB_ACTOR" '.[$user] // empty')

          if [ -n "$SLACK_ID" ]; then
            echo "text=<@$SLACK_ID>" >> $GITHUB_OUTPUT
          else
            echo "text=@$GITHUB_ACTOR" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack - Preview Ready
        if: steps.logs.outputs.has_changes == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "#f0ad4e",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üîç Liquibase Preview - Changes Detected",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Database:*\n`${{ inputs.database_name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Triggered by:*\n${{ steps.mention.outputs.text }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Preview Run ID:*\n`${{ github.run_id }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Repo:*\n<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "‚è≥ Revisa el SQL y usa el *Preview Run ID* de arriba para aplicar"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìã View SQL Preview",
                            "emoji": true
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "‚ñ∂Ô∏è Apply Migration",
                            "emoji": true
                          },
                          "style": "primary",
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/workflows/${{ inputs.apply_workflow_name }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }

      - name: Notify Slack - No Changes
        if: steps.logs.outputs.has_changes == 'false'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "#6c757d",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚ÑπÔ∏è Liquibase Preview - No Changes",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Database:*\n`${{ inputs.database_name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Triggered by:*\n${{ steps.mention.outputs.text }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Preview Run ID:*\n`${{ github.run_id }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Status:*\nNo pending migrations"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìã View Logs",
                            "emoji": true
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }

  notify-failure:
    needs: preview
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Set Slack mention
        id: mention
        env:
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          SLACK_MAP=$(curl -s "https://raw.githubusercontent.com/TetherEducation/tether-ci-cd/staging/config/slack-users.json")
          SLACK_ID=$(echo "$SLACK_MAP" | jq -r --arg user "$GITHUB_ACTOR" '.[$user] // empty')
          if [ -n "$SLACK_ID" ]; then
            echo "text=<@$SLACK_ID>" >> $GITHUB_OUTPUT
          else
            echo "text=@$GITHUB_ACTOR" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack - Failure
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚ùå Liquibase Preview - Failed",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Database:*\n`${{ inputs.database_name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Triggered by:*\n${{ steps.mention.outputs.text }}"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üîç View Logs",
                            "emoji": true
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
