name: Liquibase Migration with Approval

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "Environment name for approval gate"
      project_id:
        required: true
        type: string
        description: "GCP Project ID"
      region:
        required: false
        type: string
        default: "us-central1"
      wif_provider:
        required: true
        type: string
        description: "Workload Identity Federation provider"
      service_account:
        required: true
        type: string
        description: "GCP Service Account email"
      artifact_registry:
        required: true
        type: string
        description: "Artifact Registry URL (e.g., us-central1-docker.pkg.dev)"
      repository:
        required: true
        type: string
        description: "Artifact Registry repository name"
      image_name:
        required: true
        type: string
        description: "Docker image name"
      job_name:
        required: true
        type: string
        description: "Cloud Run Job name"
      database_name:
        required: true
        type: string
        description: "Target database name"
      changelog_file:
        required: false
        type: string
        default: "changelog.master.xml"
      db_secret_name:
        required: true
        type: string
        description: "Secret Manager secret name for DB password"
      dockerfile:
        required: false
        type: string
        default: "Dockerfile.liquibase"
    secrets:
      SLACK_WEBHOOK_URL:
        required: false
      SLACK_BOT_TOKEN:
        required: false
    outputs:
      preview_status:
        description: "Preview job status"
        value: ${{ jobs.preview.outputs.status }}
      has_changes:
        description: "Whether there are pending changesets"
        value: ${{ jobs.preview.outputs.has_changes }}

permissions:
  contents: read
  id-token: write

jobs:
  preview:
    name: Preview Migration
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.preview.outputs.status }}
      has_changes: ${{ steps.preview.outputs.has_changes }}
      preview_output: ${{ steps.preview.outputs.preview_output }}
    env:
      PROJECT_ID: ${{ inputs.project_id }}
      REGION: ${{ inputs.region }}
      ARTIFACT_REGISTRY: ${{ inputs.artifact_registry }}
      REPOSITORY: ${{ inputs.repository }}
      IMAGE_NAME: ${{ inputs.image_name }}
      JOB_NAME: ${{ inputs.job_name }}
      DATABASE_NAME: ${{ inputs.database_name }}
      CHANGELOG_FILE: ${{ inputs.changelog_file }}
      DB_SECRET_NAME: ${{ inputs.db_secret_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ inputs.wif_provider }}
          service_account: ${{ inputs.service_account }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "$ARTIFACT_REGISTRY"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          push: true
          tags: |
            ${{ inputs.artifact_registry }}/${{ inputs.project_id }}/${{ inputs.repository }}/${{ inputs.image_name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get DB Host from existing job
        id: db-host
        run: |
          DB_HOST=$(gcloud run jobs describe "$JOB_NAME" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --format="value(spec.template.spec.template.spec.containers[0].env[0].value)")
          echo "host=$DB_HOST" >> $GITHUB_OUTPUT

      - name: Run preview (update-sql)
        id: preview
        run: |
          DB_HOST="${{ steps.db-host.outputs.host }}"
          JDBC_URL="jdbc:postgresql://${DB_HOST}:5432/$DATABASE_NAME"

          # Update job with preview command
          gcloud run jobs update "$JOB_NAME" \
            --image="$ARTIFACT_REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:${{ github.sha }}" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --set-env-vars="LIQUIBASE_COMMAND_URL=$JDBC_URL,LIQUIBASE_COMMAND_USERNAME=postgres" \
            --set-secrets="LIQUIBASE_COMMAND_PASSWORD=${DB_SECRET_NAME}:latest" \
            --args="--changelog-file=$CHANGELOG_FILE,update-sql"

          # Execute preview
          echo "Executing preview (update-sql)..."
          gcloud run jobs execute "$JOB_NAME" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --wait

          # Get execution logs
          sleep 5
          LOGS=$(gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=$JOB_NAME" \
            --limit=200 \
            --project="$PROJECT_ID" \
            --format="value(textPayload)" \
            --freshness=5m 2>/dev/null || echo "Could not fetch logs")

          # Save logs to file
          echo "$LOGS" > preview-output.txt

          # Determine if there are changes
          if echo "$LOGS" | grep -q "CREATE\|ALTER\|DROP\|INSERT\|UPDATE\|DELETE"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "status=changes_detected" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "status=no_changes" >> $GITHUB_OUTPUT
          fi

          # Output summary (truncated for output)
          SUMMARY=$(echo "$LOGS" | head -50)
          echo "preview_output<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: liquibase-preview-${{ github.run_id }}
          path: preview-output.txt
          retention-days: 7

      - name: Notify Slack - Pending Review
        if: steps.preview.outputs.has_changes == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "#f0ad4e",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üîç Migration Pending Review",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Repo:*\n<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Database:*\n`${{ inputs.database_name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Environment:*\n${{ inputs.environment }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Triggered by:*\n@${{ github.actor }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "‚è≥ Waiting for approval to apply migration"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìã View SQL Preview",
                            "emoji": true
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "‚úÖ Approve Migration",
                            "emoji": true
                          },
                          "style": "primary",
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }

      - name: Notify Slack - No Changes
        if: steps.preview.outputs.has_changes == 'false'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "#6c757d",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "‚ÑπÔ∏è *No pending migrations* for `${{ inputs.database_name }}` in ${{ inputs.environment }}"
                      }
                    }
                  ]
                }
              ]
            }

  migrate:
    name: Apply Migration
    needs: preview
    if: needs.preview.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      PROJECT_ID: ${{ inputs.project_id }}
      REGION: ${{ inputs.region }}
      ARTIFACT_REGISTRY: ${{ inputs.artifact_registry }}
      REPOSITORY: ${{ inputs.repository }}
      IMAGE_NAME: ${{ inputs.image_name }}
      JOB_NAME: ${{ inputs.job_name }}
      DATABASE_NAME: ${{ inputs.database_name }}
      CHANGELOG_FILE: ${{ inputs.changelog_file }}
      DB_SECRET_NAME: ${{ inputs.db_secret_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ inputs.wif_provider }}
          service_account: ${{ inputs.service_account }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get DB Host from existing job
        id: db-host
        run: |
          DB_HOST=$(gcloud run jobs describe "$JOB_NAME" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --format="value(spec.template.spec.template.spec.containers[0].env[0].value)")
          echo "host=$DB_HOST" >> $GITHUB_OUTPUT

      - name: Apply migration
        run: |
          DB_HOST="${{ steps.db-host.outputs.host }}"
          JDBC_URL="jdbc:postgresql://${DB_HOST}:5432/$DATABASE_NAME"

          # Update job with apply command
          gcloud run jobs update "$JOB_NAME" \
            --image="$ARTIFACT_REGISTRY/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:${{ github.sha }}" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --set-env-vars="LIQUIBASE_COMMAND_URL=$JDBC_URL,LIQUIBASE_COMMAND_USERNAME=postgres" \
            --set-secrets="LIQUIBASE_COMMAND_PASSWORD=${DB_SECRET_NAME}:latest" \
            --args="--changelog-file=$CHANGELOG_FILE,update"

          echo "Executing migration (update)..."
          gcloud run jobs execute "$JOB_NAME" \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --wait

          echo "Migration completed successfully."

      - name: Get execution logs
        if: always()
        run: |
          echo "Fetching migration logs..."
          sleep 5
          gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=$JOB_NAME" \
            --limit=100 \
            --project="$PROJECT_ID" \
            --format="table(timestamp,textPayload)" \
            --freshness=5m \
            || echo "Could not fetch logs"

  notify-success:
    needs: [preview, migrate]
    if: success() && needs.preview.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack - Success
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "#36a64f",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚úÖ Migration Completed",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Database:*\n`${{ inputs.database_name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Environment:*\n${{ inputs.environment }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "Approved by @${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
                        }
                      ]
                    }
                  ]
                }
              ]
            }

  notify-failure:
    needs: [preview, migrate]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack - Failure
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚ùå Migration Failed",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Database:*\n`${{ inputs.database_name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Environment:*\n${{ inputs.environment }}"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üîç View Logs",
                            "emoji": true
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
